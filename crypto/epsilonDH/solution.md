# epsilonDH

We are given files `chall.py` and `out.txt` as follows:<br/>

### chall.py
```Python3
from Crypto.Util.number import getStrongPrime, getRandomNBitInteger, bytes_to_long
import os

p = getStrongPrime(1024)
flag = os.getenv("flag", "wwf{<REDACTED>}").encode()

class Epsilon:
    def __init__(self, a, b):
        self.a, self.b = a, b
    
    def __add__(self, other):
        if type(other) == int: other = Epsilon(other, 0)
        return Epsilon(self.a + other.a, self.b + other.b)
    def __radd__(self, other): return self.__add__(other)

    def __mul__(self, other):
        if type(other) == int: other = Epsilon(other, 0)
        return Epsilon(self.a * other.a, self.a * other.b + other.a * self.b)
    def __rmul__(self, other): return self.__mul__(other)

    def __mod__(self, other: int):
        return Epsilon(self.a % other, self.b % other)
    
    def __repr__(self): return f"{self.a} + {self.b}ɛ"

    @staticmethod
    def getRandomBits(n):
        return Epsilon(getRandomNBitInteger(n), getRandomNBitInteger(n))

def powm(b, e, m):
    r = 1
    while e > 1:
        if e & 1:
            r = (r * b) % m
        b = (b * b)  % m
        e >>= 1
    return (b * r) % m

ɛ = Epsilon(0, 1)
g = ɛ.getRandomBits(1024)
m = bytes_to_long(flag)
assert m < p
A = powm(g, m, p)

print(f"{p = }")
print(f"{g = }")
print(f"{A = }")
```

### out.txt
```
p = 173924944755645003178406095718617168013285320974193311533464918516351624141198287888308296721497553891802368640344837769848433705383843820088678374708528763495103734488139368870389319280613181418960926879728892929013723036956818870578758055144789952650214552781344528622703875374067812710366180881422848078127
g = 153222010878956025592659771364999461265827693159532862299380012549533704470078014065110463612108844661289052080113198166134196684645743591092035461757997498335465019478118882739217108862526250347939116529661007420054504044554198442479469991584947626223020239910145162698053768142977329057860163194054350707249 + 172891042743500566967040288858220451145776247635832845268756172370398885506225014595399937064138727095012954778403481826951857306135326675358326250562011754152669045113179084291737802426967956129601732530346663460456772733886633658030480267226610996560624379249886941665142384623344612516572694197005870648544ɛ
A = 111358852433093434730054197107140594544307303976075171645711474646957878889456280742672183479878216988442037548855367380131019369757301409440037291726826948896290153981733240859717678222235993520619121828503359668550259222802623131077882382174117682287404839404525320091636778728025592053329591735052259548204 + 45354415949210290456746549581237886628185346518296265188224888250560968013577364380436312628842962917052795341010011570997705657164666282067908433629612354440756444902895692385443905786057605548586533595209894409891955713650856537806150873335015064767898088756645985769501205659617651498842444073593828856739ɛ
```
From the code, we need to find $m$ such that $g^{m} \equiv A \pmod{p}$. At first, the exponential, multiplication and addition operations may be tricky to understand, so it is probably better to write down the process for small values of $m$.

Let $g = a + b\epsilon$, then <br/>
- $g^{2} \mod p = ((a + b\epsilon) * (a + b\epsilon)) \mod p = (a^{2} + 2ab\epsilon) \mod p$
- $g^{3} \mod p = ((a^{2} + 2ab\epsilon) * (a + b\epsilon)) \mod p = (a^{3} + 3a^{2}b\epsilon) \mod p$
- $g^{4} \mod p = ((a^{2} + 2ab\epsilon) * (a^{2} + 2ab\epsilon)) \mod p = (a^{4} + 4a^{3}b\epsilon) \mod p$
- ...<br/>
$\implies g^{m} \mod p = A = (a^{m} + ma^{m-1}b\epsilon) \mod p$<br/>

This is essentially the first 2 terms in the binomial expansion of $(a + b\epsilon)^{m}$ (with increasing powers of $a$). Let $A = c + d\epsilon%. By comparing the coefficients of $A$ and $g$ we have:<br/>
- $c \equiv a^{m} \pmod{p}$, and
- $d \equiv ma^{m - 1}b \pmod{p}$

We can see that $c$ and $d$ are very similar. In fact, we can establish a relationship between $c$ and $d$ as $bc * m \equiv ad \pmod{p}$. Then we can rearrange the equation to find $m$ as $m \equiv (ad) * (bc)^{-1} \pmod{p}$.

### Solve script
```Python3
from Crypto.Util.number import long_to_bytes

# Copied from out.txt
p = 173924944755645003178406095718617168013285320974193311533464918516351624141198287888308296721497553891802368640344837769848433705383843820088678374708528763495103734488139368870389319280613181418960926879728892929013723036956818870578758055144789952650214552781344528622703875374067812710366180881422848078127
# g = a + bɛ
a, b = 153222010878956025592659771364999461265827693159532862299380012549533704470078014065110463612108844661289052080113198166134196684645743591092035461757997498335465019478118882739217108862526250347939116529661007420054504044554198442479469991584947626223020239910145162698053768142977329057860163194054350707249, 172891042743500566967040288858220451145776247635832845268756172370398885506225014595399937064138727095012954778403481826951857306135326675358326250562011754152669045113179084291737802426967956129601732530346663460456772733886633658030480267226610996560624379249886941665142384623344612516572694197005870648544
# A = c + dɛ
c, d = 111358852433093434730054197107140594544307303976075171645711474646957878889456280742672183479878216988442037548855367380131019369757301409440037291726826948896290153981733240859717678222235993520619121828503359668550259222802623131077882382174117682287404839404525320091636778728025592053329591735052259548204, 45354415949210290456746549581237886628185346518296265188224888250560968013577364380436312628842962917052795341010011570997705657164666282067908433629612354440756444902895692385443905786057605548586533595209894409891955713650856537806150873335015064767898088756645985769501205659617651498842444073593828856739

# bc * m = ad (mod p)
x = b * c
y = a * d

# Message
m = (y * pow(x, -1, p)) % p
# Convert to bytes
print(long_to_bytes(m))
```
## Flag
```
wwf{3psil0n_1s_k1dn4_0P}
```
